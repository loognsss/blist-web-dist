import{aq as p,b as P,b2 as A,bj as z,q as f,y as t,an as E,b4 as Y,bQ as te,S as m,aK as Q,cy as Ne,cz as Ge,a9 as L,bR as fe,cY as $e,D as y,bk as F,n as Z,G as x,aa as N,cZ as je,c_ as C,K as ke,c$ as Ke,cw as xe,x as Ue,r as Ve,I as We,J as R,bM as qe,d0 as He,aS as G,cc as ye,d1 as ve,cd as Se,ar as re}from"./index-222e4ced.js";import{P as Je}from"./Paginator-114a7147.js";const Qe={7:"danger",2:"success",4:"neutral"},Xe=e=>{if(e.role<0)return null;const n=["info","neutral","accent"];return t(xe,{get colorScheme(){return n[e.role]},css:{overflow:"hidden",whiteSpace:"nowrap",textOverflow:"ellipsis"},get children(){return e.name}})},Ye=e=>{const n=P();return t(xe,{get colorScheme(){var l;return(l=Qe[e.state])!=null?l:"info"},get children(){return n("tasks.state.".concat(e.state))}})},s=[{name:"name",textAlign:"left",w:p().role===2?"calc(100% - 660px)":"calc(100% - 560px)"},{name:"creator",textAlign:"center",w:p().role===2?"100px":"0"},{name:"state",textAlign:"center",w:"100px"},{name:"progress",textAlign:"left",w:"140px"},{name:"speed",textAlign:"center",w:"100px"},{name:"operation",textAlign:"right",w:"220px"}],X=e=>Math.floor(e).toString().padStart(2,"0"),Ze=e=>{const n=e/1e3%60,l=e/1e3/60%60,i=e/1e3/3600;return"".concat(X(i),":").concat(X(l),":").concat(X(n))},et=e=>{const n=P(),l=e.done==="undone"?"cancel":"delete",i=e.done==="done"&&(e.state===7||e.state===4),[d,g]=A(()=>z.post("/task/".concat(e.type,"/").concat(l,"?tid=").concat(e.id))),[_,v]=A(()=>z.post("/task/".concat(e.type,"/retry?tid=").concat(e.id))),[u,w]=f(!1),T=e.name.match(e.nameAnalyzer.regex),I=T===null?e.name:e.nameAnalyzer.title(T),h=e.start_time===null?-1:new Date(e.start_time).getTime(),j=e.end_time===null?new Date().getTime():new Date(e.end_time).getTime();let O="-";const K=(c,$)=>{let S=$/c,D="bytes/s";return S>1024&&(S/=1024,D="KB/s"),S>1024&&(S/=1024,D="MB/s"),S>1024&&(S/=1024,D="GB/s"),"".concat(S.toFixed(2)," ").concat(D)};if(e.done){if(e.start_time!==e.end_time&&e.progress>0&&h!==-1){const c=(j-h)/1e3,$=e.total_bytes*e.progress/100;O=K(c,$)}}else if(e.prevProgress!==void 0&&e.prevFetchTime!==void 0){const c=(e.curFetchTime-e.prevFetchTime)/1e3,$=(e.progress-e.prevProgress)*e.total_bytes/100;O=K(c,$)}return t(m,{get when(){return!u()},get children(){return[t(E,{w:"$full",p:"$2",get children(){return[t(E,{get w(){return s[0].w},spacing:"$1",get children(){return[t(Y,{"on:click":c=>{c.stopPropagation()},get checked(){return e.local.selected},onChange:c=>{e.setLocal({selected:c.target.checked,expanded:e.local.expanded})}}),t(te,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:I})]}}),t(m,{get when(){return p().role===2},get children(){return t(Q,{get w(){return s[1].w},get children(){return t(Xe,{get name(){return e.creator},get role(){return e.creator_role}})}})}}),t(Q,{get w(){return s[2].w},get children(){return t(Ye,{get state(){return e.state}})}}),t(Ne,{get w(){return s[3].w},trackColor:"$info3",rounded:"$full",size:"sm",get value(){return e.progress},mr:"$1",get children(){return t(Ge,{color:"$info8",rounded:"$md"})}}),t(Q,{get w(){return s[1].w},get children(){return t(L,{size:"sm",css:{whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"},children:O})}}),t(fe,{get w(){return s[5].w},gap:"$1",get children(){return[t($e,{}),t(m,{get when(){return e.canRetry},get children(){return t(y,{size:"sm",disabled:!i,display:i?"block":"none",get loading(){return _()},onClick:async()=>{const c=await v();F(c,()=>{Z.info(n("tasks.retry")),w(!0)})},get children(){return n("tasks.retry")}})}}),t(y,{size:"sm",colorScheme:"danger",get loading(){return d()},onClick:async()=>{const c=await g();F(c,()=>{Z.success(n("global.delete_success")),w(!0)})},get children(){return n("global.".concat(l))}}),t(y,{size:"sm",colorScheme:"neutral",onClick:()=>{e.setLocal({selected:e.local.selected,expanded:!e.local.expanded})},get children(){return x(()=>!!e.local.expanded)()?n("tasks.fold"):n("tasks.expand")}})]}})]}}),t(m,{get when(){return e.local.expanded},get children(){return t(N,{css:{wordBreak:"break-all",fontSize:"0.8em"},w:"$full",pl:"$2",pr:"$2",get children(){return[t(je,{templateColumns:"min-content 1fr",w:"$full",columnGap:"$4",mb:"$2",get children(){return[t(m,{when:h!==-1,get children(){return[t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.time_elapsed")}}),t(C,{color:"$neutral9",get children(){return Ze(j-h)}})]}}),t(m,{when:T!==null,get children(){return t(ke,{get each(){return Object.entries(e.nameAnalyzer.attrs)},children:c=>{const $=c[1](T);return $===void 0?null:t(m,{get when(){return c[1]!==void 0},get children(){return[t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return c[0]}}),t(C,{color:"$neutral9",children:$})]}})}})}}),t(C,{color:"$neutral9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.status")}}),t(C,{color:"$neutral9",get children(){return e.status}}),t(m,{get when(){return e.error},get children(){return[t(C,{color:"$danger9",textAlign:"right",css:{whiteSpace:"nowrap"},get children(){return n("tasks.attr.err")}}),t(C,{color:"$danger9",get children(){return e.error}})]}})]}}),t(Ke,{})]}})}})]}})},tt=e=>{const n=P(),[l,i]=A(()=>z.get("/task/".concat(e.type,"/").concat(e.done))),[d,g]=f([]),[_,v]=f("name"),[u,w]=f(!1),T={name:(r,a)=>r.name>a.name?1:-1,creator:(r,a)=>r.creator===a.creator?r.id>a.id?1:-1:r.creator>a.creator?1:-1,state:(r,a)=>r.state===a.state?r.id>a.id?1:-1:r.state>a.state?1:-1,progress:(r,a)=>r.progress===a.progress?r.id>a.id?1:-1:r.progress<a.progress?1:-1},I=x(()=>(r,a)=>(u()?-1:1)*T[_()](r,a)),h=async()=>{const r=await i();F(r,a=>{var me;const k=new Date().getTime(),de={},ge={},q={},ue={},he={};for(const o of d())de[o.id]=o.curFetchTime,ge[o.id]=o.prevFetchTime,q[o.id]=o.progress,ue[o.id]=o.prevProgress,he[o.id]=o.local;g((me=a==null?void 0:a.map(o=>{var we;let H,J;o.progress===q[o.id]?(H=ge[o.id],J=ue[o.id]):(H=de[o.id],J=q[o.id]);const Ee=(we=he[o.id])!=null?we:{selected:!1,expanded:!1};return{...o,curFetchTime:k,prevFetchTime:H,prevProgress:J,local:Ee}}).sort(I()))!=null?me:[])})};if(h(),e.done==="undone"){const r=setInterval(h,2e3);Ue(()=>clearInterval(r))}const[j,O]=A(()=>z.post("/task/".concat(e.type,"/clear_done"))),[K,c]=A(()=>z.post("/task/".concat(e.type,"/clear_succeeded"))),[$,S]=A(()=>z.post("/task/".concat(e.type,"/retry_failed"))),[D,pe]=f(""),[_e,Te]=f(new RegExp("")),[be,ne]=f(!1);Ve(()=>{try{Te(new RegExp(D())),ne(!1)}catch(r){ne(!0)}});const[ae,Ce]=f(p().role!==2),V=x(()=>{const r=_e(),a=ae();return k=>r.test(k.name)&&(!a||k.creator===p().username)}),b=x(()=>d().filter(V())),se=x(()=>b().map(r=>r.local.selected).every(Boolean)),Ae=x(()=>b().map(r=>r.local.selected).some(Boolean)&&!se()),ze=r=>g(d().map(a=>(V()(a)&&(a.local.selected=r),a))),le=x(()=>b().map(r=>r.local.expanded).every(Boolean)),Fe=r=>g(d().map(a=>(V()(a)&&(a.local.expanded=r),a))),ce=()=>b().filter(r=>r.local.selected).map(r=>r.id),[Pe,De]=A(()=>z.post("/task/".concat(e.type,"/retry_some"),ce())),[Re,Le]=A(()=>z.post("/task/".concat(e.type,"/").concat(ie,"_some"),ce())),oe=r=>{Object.entries(r).forEach(([a,k])=>{Z.error("".concat(a,": ").concat(k))})},[Ie,Me]=f(1),W=20,ie=e.done==="undone"?"cancel":"delete",Be=x(()=>{const r=(Ie()-1)*W,a=r+W;return b().slice(r,a)}),M=r=>({fontWeight:"bold",fontSize:"$sm",color:"$neutral11",textAlign:r.textAlign}),U=r=>({cursor:"pointer",onClick:()=>{_()===r.name?w(!u()):qe(()=>{v(r.name),w(!1)}),h()}}),Oe=r=>a=>g(d().map(k=>(k.id===r&&(k.local=a),k)));return t(N,{w:"$full",alignItems:"start",spacing:"$2",get children(){return[t(te,{size:"lg",get children(){return n("tasks.".concat(e.done))}}),t(E,{gap:"$2",flexWrap:"wrap",get children(){return[t(m,{get when(){return e.done==="done"},get children(){return[t(y,{colorScheme:"accent",get loading(){return l()},onClick:h,get children(){return n("global.refresh")}}),t(y,{get loading(){return $()},onClick:async()=>{const r=await S();F(r,()=>h())},get children(){return n("tasks.retry_failed")}}),t(y,{colorScheme:"danger",get loading(){return j()},onClick:async()=>{const r=await O();F(r,()=>h())},get children(){return n("global.clear")}}),t(y,{colorScheme:"success",get loading(){return K()},onClick:async()=>{const r=await c();F(r,()=>h())},get children(){return n("tasks.clear_succeeded")}})]}}),t(m,{get when(){return e.canRetry},get children(){return t(y,{colorScheme:"primary",get loading(){return Pe()},onClick:async()=>{const r=await De();F(r,a=>{oe(a),h()})},get children(){return n("tasks.retry_selected")}})}}),t(y,{colorScheme:"warning",get loading(){return Re()},onClick:async()=>{const r=await Le();F(r,a=>{oe(a),h()})},get children(){return n("tasks.".concat(ie,"_selected"))}}),t(We,{width:"auto",get placeholder(){return n("tasks.filter")},get value(){return D()},onInput:r=>pe(r.target.value),get invalid(){return be()}}),t(m,{get when(){return p().role===2},get children(){return t(Y,{get checked(){return ae()},onChange:r=>Ce(r.target.checked),get children(){return n("tasks.show_only_mine")}})}})]}}),t(N,{w:{"@initial":"1024px","@lg":"$full"},overflowX:"auto",shadow:"$md",rounded:"$lg",spacing:"$1",p:"$1",get children(){return[t(E,{class:"title",w:"$full",p:"$2",get children(){return[t(E,{get w(){return s[0].w},spacing:"$1",get children(){return[t(Y,{get disabled(){return b().length===0},get checked(){return se()},get indeterminate(){return Ae()},onChange:r=>ze(r.target.checked)}),t(L,R(()=>M(s[0]),()=>U(s[0]),{get children(){return n("tasks.attr.".concat(s[0].name))}}))]}}),t(m,{get when(){return p().role===2},get children(){return t(L,R({get w(){return s[1].w}},()=>M(s[1]),()=>U(s[1]),{get children(){return n("tasks.attr.".concat(s[1].name))}}))}}),t(L,R({get w(){return s[2].w}},()=>M(s[2]),()=>U(s[2]),{get children(){return n("tasks.attr.".concat(s[2].name))}})),t(L,R({get w(){return s[3].w}},()=>M(s[3]),()=>U(s[3]),{get children(){return n("tasks.attr.".concat(s[3].name))}})),t(L,R({get w(){return s[4].w}},()=>M(s[4]),{get children(){return n("tasks.attr.".concat(s[4].name))}})),t(fe,{get w(){return s[5].w},gap:"$2",get children(){return[t($e,{}),t(L,R(()=>M(s[5]),{get children(){return n("tasks.attr.".concat(s[5].name))}})),t(y,{size:"xs",colorScheme:"neutral",onClick:()=>Fe(!le()),get disabled(){return b().length===0},get children(){return x(()=>!!le())()?n("tasks.fold_all"):n("tasks.expand_all")}})]}})]}}),x(()=>Be().map(r=>t(et,R(r,e,{get setLocal(){return Oe(r.id)}}))))]}}),t(Je,{get total(){return b().length},defaultPageSize:W,onChange:r=>{Me(r)}})]}})},lt=e=>{const n=P();return t(N,{w:"$full",alignItems:"start",spacing:"$4",get children(){return[t(te,{size:"xl",get children(){return n("tasks.".concat(e.type))}}),t(N,{w:"$full",spacing:"$2",get children(){return t(ke,{each:["undone","done"],children:l=>t(tt,{get type(){return e.type},done:l,get canRetry(){return e.canRetry},get nameAnalyzer(){return e.nameAnalyzer}})})}})]}})};var rt=re("<a>"),ee=re("<p>"),nt=re("<a target=_blank>");const B=(e,n,l=!0)=>{const i=(e==="/"?"":e)+n,d=p().base_path==="/"?"":p().base_path,g=i.startsWith(d),[_,v]=f(!1);return g&&l?(()=>{var u=rt();return u.$$mouseout=()=>v(!1),u.$$mouseover=()=>v(!0),G(u,i),ye(w=>{var T=_()?"text-decoration: underline":"",I=i.slice(d.length);return w.e=ve(u,T,w.e),I!==w.t&&Se(u,"href",w.t=I),w},{e:void 0,t:void 0}),u})():(()=>{var u=ee();return G(u,i),u})()},ct=()=>{const e=P(),[n,l]=f(!1);return{regex:/^download (.+) to \((.+)\)$/,title:i=>i[1],attrs:{[e("tasks.attr.offline_download.url")]:i=>(()=>{var d=nt();return d.$$mouseout=()=>l(!1),d.$$mouseover=()=>l(!0),G(d,()=>i[1]),ye(g=>{var _=n()?"text-decoration: underline":"",v=i[1];return g.e=ve(d,_,g.e),v!==g.t&&Se(d,"href",g.t=v),g},{e:void 0,t:void 0}),d})(),[e("tasks.attr.offline_download.path")]:i=>B("",i[2])}}},ot=()=>{const e=P();return{regex:/^transfer \[(.*)]\((.*\/([^\/]+))\) to \[(.+)]\((.+)\)$/,title:n=>n[3],attrs:{[e("tasks.attr.offline_download.transfer_src")]:n=>n[1]===""?void 0:B(n[1],n[2]),[e("tasks.attr.offline_download.transfer_src_local")]:n=>n[1]===""?n[2]:void 0,[e("tasks.attr.offline_download.transfer_dst")]:n=>B(n[4],n[5])}}},it=()=>{const e=P();return{regex:/^decompress \[(.+)]\((.*\/([^\/]+))\)\[(.+)] to \[(.+)]\((.+)\) with password <(.*)>$/,title:n=>n[3],attrs:{[e("tasks.attr.decompress.src")]:n=>B(n[1],n[2]),[e("tasks.attr.decompress.dst")]:n=>B(n[5],n[6]),[e("tasks.attr.decompress.inner")]:n=>(()=>{var l=ee();return G(l,()=>n[4]),l})(),[e("tasks.attr.decompress.password")]:n=>(()=>{var l=ee();return G(l,()=>n[7]),l})()}}},dt=()=>{const e=P();return{regex:/^upload (.+) to \[(.+)]\((.+)\)$/,title:n=>n[1],attrs:{[e("tasks.attr.decompress.dst")]:n=>B(n[2],n[3])}}};He(["mouseover","mouseout"]);export{lt as T,ot as a,B as b,it as c,dt as d,ct as g};
